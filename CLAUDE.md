# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

**Main Commands:**
- `pnpm dev` - Run development server with hot reload using tsx watch
- `pnpm start` - Run production server
- `pnpm test` - Run all tests with verbose output
- `pnpm test:watch` - Run tests in watch mode
- `pnpm test:ci` - Run tests with coverage for CI (silent mode)
- `pnpm typecheck` - Type check without emitting files
- `pnpm lint` - Lint source code using Biome
- `pnpm format` - Format source code using Biome

**Database Commands:**
- `pnpm docker` - Start PostgreSQL and Redis containers via docker-compose
- `drizzle-kit generate` - Generate migrations from schema changes
- `drizzle-kit migrate` - Apply migrations to database
- `drizzle-kit studio` - Launch Drizzle Studio for database exploration

**Testing:**
- Run single test file: `pnpm test src/path/to/file.test.ts`
- Tests use Jest with ts-jest transform
- Test files follow pattern: `*.test.ts` in src/
- Coverage reports generated in `coverage/` directory

## Architecture Overview

This is a **Fastify-based REST API** for a double-entry ledger system built with TypeScript, Drizzle ORM, and PostgreSQL.

### Core Architecture Pattern

The application follows a **layered architecture** with dependency injection via Fastify plugins:

```
Routes → Services → Repositories → Database
```

**Plugin System (key to understanding the codebase):**
- `RepoPlugin` - Database repositories using Drizzle ORM
- `ServicePlugin` - Business logic services 
- `RouterPlugin` - HTTP route handlers with JWT auth
- All plugins extend Fastify instance via module declaration

### Directory Structure

```
src/
├── server.ts          # Fastify server setup and plugin registration
├── index.ts          # Application entry point
├── config.ts         # Environment configuration
├── auth.ts          # JWT authentication setup
├── errors.ts        # Global error handling
├── repo/            # Database layer (Drizzle ORM)
│   ├── schema.ts    # Database schema definitions
│   ├── *Repo.ts     # Repository classes
│   └── migrations.ts
├── services/        # Business logic layer
│   ├── entities/    # Domain entities/DTOs
│   └── *Service.ts  # Service classes
└── routes/          # HTTP API layer
    ├── *Routes.ts   # Route handlers
    ├── ledgers/     # Ledger-specific routes
    └── schema.ts    # Request/response schemas
```

### Key Architectural Concepts

**Database Layer (Drizzle ORM):**
- Schema-first approach with type inference
- Migrations in `migrations/` directory generated by drizzle-kit
- Repository pattern for data access abstraction

**Service Layer:**
- Domain business logic separated from HTTP concerns
- Services injected into Fastify instance and available on `server.services`
- Entity classes define domain models and validation

**Route Layer:**
- Uses `@fastify/type-provider-typebox` for runtime type validation
- JWT authentication via `@fastify/auth` and `@fastify/jwt`
- OpenAPI/Swagger documentation auto-generated
- All API routes prefixed with `/api`

**Configuration:**
- Environment variables loaded via `@dotenvx/dotenvx`
- Test environment uses separate `.env.test` file
- Config class centralizes environment variable access

### Domain Model

This is a **multi-tenant ledger system**:
- **Organizations** - Top-level tenants
- **Ledgers** - Chart of accounts within an organization  
- **Accounts** - Individual ledger accounts (assets, liabilities, etc.)
- **Transactions** - Double-entry transactions with multiple entries
- **Entries** - Individual debit/credit entries within transactions

### Development Workflow

**Making Changes:**
1. Update schema in `src/repo/schema.ts` if needed
2. Generate migrations: `drizzle-kit generate`
3. Update repository methods in `src/repo/*Repo.ts`
4. Update service layer in `src/services/*Service.ts`
5. Update route handlers in `src/routes/*Routes.ts`
6. Add/update tests alongside implementation
7. Run `pnpm typecheck` and `pnpm lint` before committing

**Code Style:**
- Uses Biome for formatting and linting (not Prettier/ESLint)
- Tab indentation, double quotes for strings
- Path aliases: `@/*` maps to `src/*`
- No semicolons in TypeScript (Biome default)

**Authentication:**
- JWT-based authentication required for all API routes
- Auth setup in `src/auth.ts` using `@fastify/auth` and `@fastify/jwt`
- Swagger UI includes bearer token auth configuration